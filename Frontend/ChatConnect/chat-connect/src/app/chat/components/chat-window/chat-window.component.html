<div class="chat-window">
  <div class="chat-header">
    <h3>{{ getTitle() }}</h3>
  </div>

  <div class="messages">
    <div class="message" *ngFor="let msg of messages" [ngClass]="{
        'message-mine': msg.senderName === currentUser,
        'message-other': msg.senderName !== currentUser
      }">
      <div *ngIf="selectedGroup && msg.senderName" class="sender-name">
        {{ msg.senderName }}
      </div>

      <div class="message-text" *ngIf="!isImageMessage(msg)">
        {{ msg.content }}
      </div>

      <img *ngIf="isImageMessage(msg)" 
           [src]="msg.content" 
           class="img-fluid rounded" 
           style="max-width: 200px; max-height: 200px; cursor: pointer;" 
           [alt]="'Image from ' + msg.senderName"
           (click)="onImageClick(msg.content)">

      <div class="message-meta">
        <span class="time">
          {{ msg.sentTime || getFormattedTime(msg.createdAt) }}
        </span>
        <span class="delete" *ngIf="msg.senderName === currentUser"
          (click)="onDelete(msg)" title="Delete message">ðŸ—‘</span>
      </div>
    </div>
    <div #bottomRef></div>
  </div>

  <div class="empty-state" *ngIf="(selectedUser || selectedGroup) && (!messages || messages.length === 0)">
    <h3>Say "Hi" ðŸ‘‹ to start a conversation.</h3>
  </div>

  <div class="message-input-container" *ngIf="selectedUser || selectedGroup">
    <div class="input-group">
      <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" class="d-none">
      <button class="btn btn-outline-secondary" type="button" (click)="fileInput.click()" title="Attach image">
        ðŸ“Ž
      </button>
      <img *ngIf="imagePreview" 
           [src]="imagePreview" 
           class="img-thumbnail me-2" 
           style="max-width: 50px; max-height: 50px;"
           alt="Preview">
      <input class="form-control" 
             [(ngModel)]="newMessage" 
             placeholder="Type a message..." 
             (keydown.enter)="onSend()"
             [disabled]="!!selectedFile">
      <button class="btn btn-primary" (click)="onSend()" [disabled]="!newMessage.trim() && !selectedFile">
        Send
      </button>
    </div>
    <div *ngIf="uploadProgress > 0" class="progress mt-2">
      <div class="progress-bar" role="progressbar" [style.width.%]="uploadProgress">Uploading...</div>
    </div>
  </div>

  <div class="empty-state" *ngIf="!selectedUser && !selectedGroup">
    <h3>Select a user or group to start chatting</h3>
  </div>
</div>